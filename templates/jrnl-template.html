<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Arvo">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Khula">
  <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800&display=swap"
      rel="stylesheet"
    />
  <link
    href="https://fonts.googleapis.com/css?family=Roboto+Slab&display=swap"
    rel="stylesheet"
  />
  <link href="{{ static_url }}css/pdf.css" rel="stylesheet"/>

{% if json_obj.export_format == '6X9' %}
  <style>
    .page {
      width: 6in;
      height: 9in;
      min-height: 9in;
      padding: 0.2in;
      margin: 0.1in auto;
      background: white;
      position: relative;
    }

    .subpage {
      height: 8.6in;
      min-height: 8.6in;
      max-height: 8.6in;
      position: relative;
    }

    @page {
      size: 6in 9in;
      margin: 0;
    }

    @media print {
      .page {
        margin: 0;
        border: initial;
        border-radius: initial;
        width: initial;
        min-height: initial;
        box-shadow: initial;
        background: initial;
        position: initial;
        page-break-after: always;
      }
    }
  </style>
{% else %}
  <style>
    .page {
      width: 210mm;
      height: 297mm;
      min-height: 297mm;
      padding: 20mm;
      margin: 10mm auto;
      background: white;
      position: relative;
    }

    .subpage {
      /*padding: 10mm;*/
      height: 257mm;
      min-height: 257mm;
      max-height: 257mm;
      position: relative;
      /*border: 1mm solid black;*/
    }
    /*.first.last.column{}*/

    @page {
      size: A4;
      margin: 0;
    }

    @media print {
      .page {
        margin: 0;
        border: initial;
        border-radius: initial;
        width: initial;
        min-height: initial;
        box-shadow: initial;
        background: initial;
        position: initial;
      }
    }

    .page:nth-child(2n) .page-number {
      left: 20mm;
    }

    .page:nth-child(2n+1) .page-number {
      right: 20mm;
    }
  </style>
{% endif %}

{% if json_obj.color is false %}
  <style>
    img { 
        -webkit-filter: grayscale(100%);
        /* Safari 6.0 - 9.0 */
        filter: grayscale(100%);
    }
  </style>
{% endif %}

{% if json_obj.preview is true %}
  <style>
    .watermark { opacity: 0.1; }
  </style>
{% endif %}

  <script type="text/javascript" src="{{ static_url }}vendors/jquery.js"></script>
  <script src="{{ static_url }}vendors/autocolumn.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="{{ static_url }}vendors/jquery-qrcode.js" type="text/javascript" charset="utf-8"></script>

  <template id="page_template">
    <div class="page">
      <div class="subpage"></div>
    </div>
  </template>
  <template id="pdf_content_template">
    <div class="pdf-content-media-content-files">
      <div class="pdf-content-media">
        <img src="" alt="audiowave" class="bnw-img">
        <div class="pdf-content-media-desc">
          <p class="file-name">${ file_name }</p>
          <p class="file-size">${secondsToHms(audio_duration)}</p>
          <p class="file-type">Audio File</p>
          <p class="file-date">Uploaded on ${created_date}</p>
        </div>
      </div>
      <div class="qrcode-demo audio">
      </div>
    </div>
  </template>
  <template id="media_document_template">
    <div class="pdf-content-media-content-files">
      <div class="pdf-content-media">
        <img src="${docFileURL}" alt="file" class="bnw-img">
        <div class="pdf-content-media-desc">
          <p class="file-name">${ file_name }</p>
          <p class="file-size">${ docFileSize }</p>
          <p class="file-type">PDF File</p>
          <p class="file-date">Uploaded on ${created_date}</p>
        </div>
      </div>
      <div class="qrcode-demo docfile">
      </div>
    </div>
  </template>
  <script>
  $(function(){
      var content_height = $('.subpage').height() - 20;	// the height of the content, discluding the header/footer
      var page = 1; // the beginning page number to show in the footer
      var pageContentIndex = 0;
      var pageContents = ['intro', 'aam', 'journals'];

      function drawQRCode(qrElem, link) {
        var logoImg = new Image;
        logoImg.src = "{{ static_url }}images/timeline-images/logo.png";
        logoImg.onload = function() {
            console.log($(qrElem));
            $(qrElem).qrcode({
                size: 80,
                fill: '#000',
                text: link,
                mode: 4,
                image: this,
                label: '111',
                fontcolor: '#F1C40F',
                ecLevel:'H',
                minVersion: 1,
                maxVersion: 40,
                render: 'canvas'
            });
        }
      }

      // console.log(content_height);
      function buildPages(name, contentPageCount){
        var targetId = "#book-content-" + name,
            targetElement = $(targetId);
        if(targetElement.contents().length > 0){
            // add page number to table of contents
            if (contentPageCount === 0) {
              $(`#${name}-pagenumber`).text(page);
            }
            // when we need to add a new page, use a jq object for a template
            // or use a long HTML string, whatever your preference
            _page = page_template.content.cloneNode(true);
            $page = $(_page);

            $page.children('.page').addClass(contentPageCount % 2 === 0 ? 'right-page' : 'left-page');

            // fun stuff, like adding page numbers to the footer
            $page.find(".footer .page-number").append(page);
            $(targetElement).parent().append($page);
            
            const targetSelector = `#${$(targetElement).parent().attr("id")} .page:last .subpage`;
            contentPageCount ++;
            // here is the columnizer magic
            targetElement.columnize({
              columns: 1,
              keepHtml: true,
              target: targetSelector,
              overflow: {
                height: content_height,
                id: targetId,
                doneFunc: function(e){
                    const title = targetElement.children().first().attr('title');
                    if (title) {
                        targetElement.prepend($(`
                        <h3 class="subtitle">
                            ${title}
                        </h3>`));
                    }

                    $(targetSelector).append(`
                      <div class="watermark">PREVIEW</div>
                      <div style="position: absolute; bottom: 0;" class="page-number"> ${page} </div>
                    `);

                    page ++;

                    buildPages(name, contentPageCount);
                  }
              }
            });
        } else {
          if (contentPageCount % 2 === 1) {
            _page = page_template.content.cloneNode(true);
            $page = $(_page);
            $(targetElement).parent().append($page);
          }

          pageContentIndex ++;
          if (pageContentIndex < pageContents.length) {
            buildPages(pageContents[pageContentIndex], 0);
          }
          else {
						const qrCodes = $(".qrcode-demo");
						for (let i = 0 ; i < qrCodes.length ; i++ ) {       
                var qrElem = qrCodes[i];
                var entry_link = $(qrElem).attr("entry_link");
								drawQRCode(qrElem, entry_link);
						}
          }
        }
      }
			
      // Handle video / audio / document files
      function secondsToHms(d) {
          d = Number(d);
          var h = Math.floor(d / 3600);
          var m = Math.floor(d % 3600 / 60);
          var s = Math.floor(d % 3600 % 60);

          var hDisplay = h > 0 ? h + (h == 1 ? " hr, " : " hrs, ") : "";
          var mDisplay = m > 0 ? m + (m == 1 ? " m, " : " ms, ") : "";
          var sDisplay = s > 0 ? s + (s == 1 ? " s" : " s") : "";
          return hDisplay + mDisplay + sDisplay; 
      }
      const handleVideoFiles = () => {
          const videos = $("video");
          for (let i = 0 ; i < videos.length ; i++) {
              const video = videos[i];
              const video_play_poster = $(video).attr("video_play_poster");
              const entry_link = $(video).attr("entry_link");
              const parent = $(video).parent();
              const image = $(`<img src="${ video_play_poster}"/>`);
              var qrElem = $(`<div class='qrcode-demo video' entry_link='${entry_link}'></div>`);
              $(parent).append(image).css("position", "relative");
              $(parent).append(qrElem);

              $(video).remove();
          }
      }

      const handleAudioFiles = () => {
          const audios = $("audio");
          for (let i = 0 ; i < audios.length ; i++) {
              const audio = audios[i];
              const entry_link = $(audio).attr("entry_link");
              const file_name = $(audio).attr("file_name");
              const audio_duration = $(audio).attr("audio_duration");
              const created_date = $(audio).attr("created_date");
              const parent = $(audio).parent();
              const waveUrl = "{{ static_url }}images/audiowave.png"
              _template = pdf_content_template.content.cloneNode(true);
              $template = $(_template);
              $($template.children()[0]).find('.bnw-img').attr('src', waveUrl);
              $($template.children()[0]).find('.file-name').text(file_name);
              $($template.children()[0]).find('.file-size').text(secondsToHms(audio_duration));
              $($template.children()[0]).find('.file-date').text(`Uploaded on ${created_date}`);          
              $($template.children()[0]).find('.qrcode-demo').attr('entry_link', entry_link);

              $(parent).append($template);

              $(audio).remove();
          }
      }

      const handleDocumentFiles = () => {
          const documents = $("q");
          for (let i = 0 ; i < documents.length ; i++) {
              const docFile = documents[i];
              const entry_link = $(docFile).attr("entry_link");
              const file_name = $(docFile).attr("name");
              const docFileSize = $(docFile).attr("formatted_size");
              const created_date = $(docFile).attr("created_date");
              const parent = $(docFile).parent();
              const docFileURL = "{{ static_url }}images/file.png"
              _template = media_document_template.content.cloneNode(true);
              $template = $(_template);
              $($template.children()[0]).find('.bnw-img').attr('src', docFileURL);
              $($template.children()[0]).find('.file-name').text(file_name);
              $($template.children()[0]).find('.file-size').text(docFileSize);
              $($template.children()[0]).find('.file-date').text(`Uploaded on ${created_date}`);
              $($template.children()[0]).find('.qrcode-demo').attr('entry_link', entry_link);
              
              $(parent).append($template);

              $(docFile).remove();
          }
      }

      // handleVideoFiles();
      // handleAudioFiles();
      // handleDocumentFiles();
      $(document).ready(() => { 
        const count = $("img").length;
        const videoCount = $("video").length;
        let  loadedCount = 0, loadedVideoCount = 0;

        if (count === 0) {
            buildPages(pageContents[0], 0);
        }
        
        $("img").load(() => {
          loadedCount ++;
          if (loadedCount === count) {
            buildPages(pageContents[0], 0);
          }
        });

        $("source").remove();
      });
     
    });
  </script>
</head>
<body>
<div class="page">
  <div class="subpage">
    <div class='content' style="position: relative; top: 50%; transform: translateY(-50%);">
      <h5 class="document-title">
        {{ json_obj.document_title }}
      </h5>
      <p class="document-date">
      {% if json_obj.document_subtitle %}
        {{ json_obj.document_subtitle }}
      {% else %}
        {{ json_obj.document_date }}
      {% endif %}
      </p>
      <img src="{{ static_url }}images/timeline-images/logo.png" class="center logo-img" alt="logo"/>
    </div>
    <div class="watermark">PREVIEW</div>
  </div>
</div>
<div class="page"><div class="subpage"><div class="watermark">PREVIEW</div></div></div>

<div class="page">
  <div class="subpage">
    <div class="table-of-contents">
      <h3>Table of Contents</h3>
        {% if json_obj.table_of_contents.intro %}
          {% set item = json_obj.table_of_contents.intro %}
          <div class="table-of-contents-body">
            {{ item.name }}
            </br>
            <span id='intro-pagenumber'>1</span>
        </div>
        {% endif %}
        {% if json_obj.table_of_contents.aam and json_obj.all_about_me != '' %}
          {% set item = json_obj.table_of_contents.aam %}
          <div class="table-of-contents-body">
            {{ item.name }}
            </br>
            <span id='aam-pagenumber'>2</span>
          </div>
        {% endif %}
        {% if json_obj.table_of_contents.journals %}
          {% set item = json_obj.table_of_contents.journals %}
          <div class="table-of-contents-body">
            {{ item.name }}
            </br>
            <span id='journals-pagenumber'>3</span>
          </div>
        {% endif %}
        <div class="end-line"></div>
    </div>
    <img src="{{ static_url }}images/timeline-images/logo.png" alt="logo" class="center logo-img" />
    <div class="watermark">PREVIEW</div>
  </div>
</div>
<div class="page"><div class="subpage"><div class="watermark">PREVIEW</div></div></div>

{% if json_obj.table_of_contents.intro %}
  {% set item = json_obj.table_of_contents.intro %}
  <div class="page">
    <div class="subpage">
      <div class="vertical-align-center">
          <h3 class="table-content-title">{{ item.name }}</h3>
          <div class='logo-img-container'>
            <div class='line left-3-margin'></div>
            <img src="{{ static_url }}images/timeline-images/logo.png" alt="logo" class="center small-logo-img"/>
            <div class='line right-3-margin'></div>
          </div>
      </div>
      <div class="watermark">PREVIEW</div>
    </div>
  </div>
  <div class="page"><div class="subpage"><div class="watermark">PREVIEW</div></div></div>
  <div id='intro'>
    <div id="book-content-intro">
      <h3 class="subtitle right-align-text">{{ item.name }}</h3>
      <div class="two-margin journal-text">{{ item.data }}</div>
    </div>
  </div>
{% endif %}

{% if json_obj.table_of_contents.aam and json_obj.all_about_me != '' %}
  {% set item = json_obj.table_of_contents.aam %}
  <div class="page">
    <div class="subpage">
      <div class="vertical-align-center">
          <h3 class="table-content-title">{{ item.name }}</h3>
          <div class='logo-img-container'>
            <div class='line left-3-margin'></div>
            <img src="{{ static_url }}images/timeline-images/logo.png" alt="logo" class="center small-logo-img"/>
            <div class='line right-3-margin'></div>
          </div>
      </div>
      <div class="watermark">PREVIEW</div>
    </div>
  </div>
  <div class="page"><div class="subpage"><div class="watermark">PREVIEW</div></div></div>
  <div id='aam'>
    <div id="book-content-aam">
      <h3 class="subtitle right-align-text">{{ item.name }}</h3>
    {% for entry in item.data.aam %}
      {% if loop.first or loop.previtem.group != entry.group %}
        <span class="two-margin aam-category-text">{{ entry.group }}</span>
      {% endif %}
      <div class="two-margin aam-question-text">{{ entry.title }}</div>
      <div class="two-margin journal-text" style="font-style: italic;">
        {{ entry.entry_date }}
      </div>
      <div class="two-margin journal-text" style="padding-bottom: 20mm;">
        {% if json_obj.photos is true %}
          {{ entry.content|safe }}
        {% else %}
          {{ entry.no_img_content|safe }}
        {% endif %}
      </div>
    {% endfor %}
    </div>
  </div>
{% endif %}

{% if json_obj.table_of_contents.journals %}
  {% set item = json_obj.table_of_contents.journals %}
  <div class="page">
    <div class="subpage">
      <div class="vertical-align-center">
          <h3 class="table-content-title">{{ item.name }}</h3>
          <div class='logo-img-container'>
            <div class='line left-3-margin'></div>
            <img src="{{ static_url }}images/timeline-images/logo.png" alt="logo" class="center small-logo-img"/>
            <div class='line right-3-margin'></div>
          </div>
      </div>
      <div class="watermark">PREVIEW</div>
    </div>
  </div>
  <div class="page"><div class="subpage"><div class="watermark">PREVIEW</div></div></div>
  <div id="journals">
  <div id="book-content-journals">
    {% for journal in item.data %}
      <div class="two-margin journal-text">
        {{ journal.content|safe }}
      </div>
      {% for entry in journal.entries %}
        <h3 class="subtitle right-align-text">{{ entry.entry_date }}</h3>
        <div title="{{entry.entry_date}}" class="two-margin journal-title-text">{{ entry.title }}</div>
        <div title="{{entry.entry_date}}" class="two-margin journal-text">
        {% if json_obj.photos is true %}
          {{ entry.content|safe }}
        {% else %}
          {{ entry.no_img_content|safe }}
        {% endif %}
        </div>
        {% if entry.commenting is true and json_obj.comments is true %}
          {% for comment in journal.comments[entry.id] %}
            {% if loop.first %}
              <div class="three-margin journal-comments-title-text">Comments:</div>
            {% endif %}
            <div class="three-margin journal-comment-container">
                <div class="journal-comment-user-container">
                    <img src="{{ comment.user.avatar_image_url }}" alt="user"/>
                </div>
                <div class="journal-comment-content-container">
                    <div class="journal-comments-text">
                        {{ comment.title }} {{ comment.content }}
                    </div>
                    <div class="journal-comment-content-info">
                        <b>{{ comment.user.short_public_display_name }}</b> &nbsp; . &nbsp; {{ comment.created }}
                    </div>
                </div>
            </div>
          {% endfor %}
        {% endif %}
      {% endfor %}
    {% endfor %}
  </div>
</div>
{% endif %}
</body>
</html>
