<!DOCTYPE html>
<html>
<head>
  <link href="{{ static_url }}css/pdf.css" rel="stylesheet"/>
  <style>
  .page {
    width: 210mm;
    height: 297mm;
    min-height: 297mm;
    padding: 20mm;
    margin: 10mm auto;
    background: white;
    position: relative;
  }

  .subpage {
    /*padding: 10mm;*/
    height: 257mm;
    min-height: 257mm;
    max-height: 257mm;
    position: relative;
    /*border: 1mm solid black;*/
  }
  /*.first.last.column{}*/

  @page {
    size: A4;
    margin: 0;
  }

  @media print {
    .page {
      margin: 0;
      border: initial;
      border-radius: initial;
      width: initial;
      min-height: initial;
      box-shadow: initial;
      background: initial;
      position: initial;
    }
  }
  </style>
  <script type="text/javascript" src="{{ static_url }}vendors/jquery.js"></script>
  <script src="{{ static_url }}vendors/autocolumn.min.js" type="text/javascript" charset="utf-8"></script>

  <template id="page_template">
    <div class="page">
      <div class="subpage"></div>
    </div>
  </template>
  <script>
  $(function(){
      var content_height = $('.page').height();	// the height of the content, discluding the header/footer
      var page = 1; // the beginning page number to show in the footer
      // console.log(content_height);
      function buildPages(name){
        var targetId = "#book-content-" + name,
            targetElement = $(targetId);
        if(targetElement.contents().length > 0){
            // when we need to add a new page, use a jq object for a template
            // or use a long HTML string, whatever your preference
            _page = page_template.content.cloneNode(true);
            $page = $(_page);

            // fun stuff, like adding page numbers to the footer
            $page.find(".footer .page-number").append(page);
            $("body").append($page);
            page++;

            // here is the columnizer magic
            targetElement.columnize({
              columns: 1,
              keepHtml: true,
              target: ".page:last .subpage",
              overflow: {
                height: content_height,
                id: targetId,
                doneFunc: function(e){
                    console.log("done with page", targetElement.children().first().attr('title'));

                    const title = targetElement.children().first().attr('title');
                    if (title) {
                        targetElement.prepend($(`
                        <h3 class="subtitle">
                            ${title}
                        </h3>`));
                    }
                    buildPages(name);
                  }
              }
            });
        } else {
          $.each($('.page'), function(i, val) {
            if (i>0) {
              $(val).find('.subpage').append(`<div style="position: absolute; bottom: 0;" class="page-number"> ${i} </div>`);
            }
          });
          /*
          const elements = $('.page');
          elements.forEach(obj => {
            obj.find('.subpage').append(`<div class="footer two-margin">
              <div class="page-number">Page ${12}</div>
            </div>`);
          });
          */
        }
      }
      buildPages('intro');
      buildPages('aam');
      buildPages('journals');
    });
  </script>
</head>
<body>
<div class="page">
  <div class="subpage">
    <div class='content' style="position: relative; top: 50%; transform: translateY(-50%);">
      <h5 class="document-title">
        {{ json_obj.document_title }}
      </h5>
      <p class="document-date">
        {{ json_obj.document_date }}
      </p>
      <img src="{{ static_url }}images/timeline-images/logo.png" alt="logo" class="center"/>
    </div>
  </div>
</div>
<div class="page">
  <div class="subpage">
    <div class="table-of-contents">
      <h3>Table of Contents</h3>
        {% if json_obj.table_of_contents.intro %}
          {% set item = json_obj.table_of_contents.intro %}
          <div class="table-of-contents-body">{{ item.name }}</div>
          <div class="end-line"></div>
        {% endif %}
        {% if json_obj.table_of_contents.aam %}
          {% set item = json_obj.table_of_contents.aam %}
          <div class="table-of-contents-body">{{ item.name }}</div>
          <div class="end-line"></div>
        {% endif %}
        {% if json_obj.table_of_contents.journals %}
          {% set item = json_obj.table_of_contents.journals %}
          <div class="table-of-contents-body">{{ item.name }}</div>
          <div class="end-line"></div>
        {% endif %}
    </div>
    <img src="{{ static_url }}images/timeline-images/logo.png" alt="logo" class="center"/>
  </div>
</div>
<div class="page">
  <div class="subpage" style="position: relative;">
    <h3 class="subtitle right-align-text">
      {{ json_obj.document_date }}
    </h3>
  </div>
</div>

{% if json_obj.table_of_contents.intro %}
  {% set item = json_obj.table_of_contents.intro %}
  <div id="book-content-intro">
    <div title="{{ item.name }}" class="two-margin journal-title-text">{{ item.name }}</div>
    <div title="{{ item.name }}" class="two-margin journal-text">
      {{ item.data }}
    </div>
  </div>
{% endif %}
{% if json_obj.table_of_contents.aam %}
  {% set item = json_obj.table_of_contents.aam %}
  <div id="book-content-aam">
    <div title="{{ item.name }}" class="two-margin journal-title-text">{{ item.name }}</div>
    <div title="{{ item.name }}" class="two-margin journal-text"></div>
    {% for page in item.data %}
        {% for aam in page.aam %}
            <div class="two-margin journal-title-text">{{ aam.title }}</div>
            <div class="two-margin journal-text">
              {{ aam.content|e }}
            </div>
        {% endfor %}
        {% for comment in page.comments %}
            <div class="two-margin journal-title-text">{{ comment.title }}</div>
            <div class="two-margin journal-text">
              {{ comment.content|e }}
            </div>
        {% endfor %}
    {% endfor %}
  </div>
{% endif %}
{% if json_obj.table_of_contents.journals %}
  {% set item = json_obj.table_of_contents.journals %}
  <div id="book-content-journals">
    <div title="{{ item.name }}" class="two-margin journal-title-text">{{ item.name }}</div>
    <div title="{{ item.name }}" class="two-margin journal-text"></div>
    {% for journal in item.data %}
      <p>{{ journal }}</p>
      <div class="two-margin journal-title-text">{{ journal.title }}</div>
      <div class="two-margin journal-text">
        {{ journal.content|e }}
      </div>
      {% for entry in journal.entries %}
        <div class="two-margin journal-title-text">{{ entry.title }}</div>
        <div class="two-margin journal-text">
          {{ entry.content|e }}
        </div>
      {% endfor %}
    {% endfor %}
  </div>
{% endif %}
</body>
</html>
